<!DOCTYPE html>
<html>
<head>
	<title>Lookmap</title>
	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="jquery.mobile-1.4.0.css"/>
    <link rel="stylesheet" href="index.css"/>
    <link rel="stylesheet" href="leaflet.css"/>
    <link rel="stylesheet" href="leaflet-plugins/awesome-markers/leaflet.awesome-markers.css">
    <link rel="stylesheet" href="leaflet-plugins/locatecontrol/L.Control.Locate.css" />
    <script type="text/javascript" src="jquery-1.10.2.js"></script> 
    <script type="text/javascript" src="jquery.mobile-1.4.0.js"></script>
    <script type="text/javascript" src="phonegap.js"></script>
    <!--<script type="text/javascript" src="stopgap.js"></script>-->
    <script type="text/javascript" src="leaflet.js"></script>
    <script type="text/javascript" src="leaflet-plugins/awesome-markers/leaflet.awesome-markers.js"></script>
    <script type="text/javascript" src="leaflet-plugins/locatecontrol/L.Control.Locate.js" ></script>
    <script type="text/javascript" src="jsonsql-0.1.js"></script>
    <script type="text/javascript" src="index.js"></script>
    <script type="text/javascript">
        document.addEventListener("deviceready", onDeviceReady, false);
        var watchID = null;
        // once the device ready event fires, you can safely do your thing! -jm
        function onDeviceReady() {
            console.log(device.name);

            var options = { enableHighAccuracy: true };
            watchID = navigator.geolocation.watchPosition(onWatchPositionSuccess, onWatchPositionError, options);

            $.ajax({
                url: "restaurants.json",
                beforeSend: function (xhr) {
                    xhr.overrideMimeType("application/json");
                }
            })
                    .done(function (data) {
                        var addType = function (json, iconType) {
                            var layer = new L.LayerGroup();
                            for (var j = 0; j < json.length; j++) {
                                var longtitude = json[j].longitude;
                                var latitude = json[j].latitude;
                                var name = json[j].name;
                                var geoLink = "<a href='geo:{latitude},{longtitude}'>{n}</a>".format({ longtitude: longtitude, latitude: latitude, n: name });
                                if (iconType !== undefined) {
                                    L.marker([latitude, longtitude], { icon: iconType }).bindPopup(geoLink).addTo(layer);
                                }
                                else {
                                    L.marker([latitude, longtitude]).bindPopup(geoLink).addTo(layer);
                                }
                            }
                            return layer;
                        };
                        var cloudMadeAttribution = 'CloudMade';
                        var cloudmadeUrl = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/{styleId}/256/{z}/{x}/{y}.png';
                        var minimal = L.tileLayer(cloudmadeUrl, { styleId: 13180, attribution: cloudMadeAttribution }),
                        midnight = L.tileLayer(cloudmadeUrl, { styleId: 999, attribution: cloudMadeAttribution });


                        var restaurantsLayer = addType(jsonsql.query("select * from json where (type =='Restauracje')", data), L.AwesomeMarkers.icon({icon: 'spinner', prefix: 'fa', markerColor: 'red', spin:true}));
                        var pubsLayer = addType(jsonsql.query("select * from json where (type =='Puby')", data), L.AwesomeMarkers.icon({ icon: 'coffee', prefix: 'fa', markerColor: 'red', iconColor: '#f28f82' }));
                        var clubsLayer = addType(jsonsql.query("select * from json where (type =='Kluby')", data), L.AwesomeMarkers.icon({ icon: 'cog', prefix: 'fa', markerColor: 'purple', iconColor: 'black' }));
                        var servicesLayer = addType(jsonsql.query("select * from json where (type =='Uslugi')", data), L.AwesomeMarkers.icon({ icon: 'glass', prefix: 'fa', markerColor: 'green' }));
                        var entertainmentLayer = addType(jsonsql.query("select * from json where (type =='Rozrywka')", data), L.AwesomeMarkers.icon({ icon: 'shopping-cart', prefix: 'fa', markerColor: 'blue' }));

                        var map = L.map('map', {
                            center: [50.05185, 19.96195],
                            zoom: 11,
                            layers: [minimal, restaurantsLayer, pubsLayer, clubsLayer, servicesLayer, entertainmentLayer]
                        });

                        L.control.locate().addTo(map);

                        var baseLayers = {
                            "Minimalny": minimal,
                            "Widok nocny": midnight
                        };

                        var overlays = {
                            "Restauracje": restaurantsLayer,
                            "Puby": pubsLayer,
                            "Kluby": clubsLayer,
                            "Usługi": servicesLayer,
                            "Rozrywka": entertainmentLayer
                        };
                        L.control.layers(baseLayers, overlays).addTo(map);
                    });

                }

                function onWatchPositionSuccess(position) {
                    var stringPosition = "[" + position.coords.latitude + ", " + position.coords.longitude + "]";
                    var element = document.getElementById('geolocation');
                    element.innerHTML = stringPosition;
                }

                // clear the watch that was started earlier
                // 
                function clearWatch() {
                    if (watchID != null) {
                        navigator.geolocation.clearWatch(watchID);
                        watchID = null;
                    }
                }

                // onError Callback receives a PositionError object
                //
                function onWatchPositionError(error) {
                    navigator.notification.alert(
                        error.message, null, 'Error', 'Ok');
                }
    </script>
</head>
    <body>
        <div id="home" data-role="page">
            <div data-role="header" data-position="fixed" data-fullscreen="true">
            <h1>Lookmap</h1>
            <div data-role="navbar">
                <ul>
                    <li><a href="#" data-icon="home">Mapa</a></li>
                    <li><a href="#" data-icon="arrow-r">Kluby</a></li>
                    <li><a href="#" data-icon="search">Puby</a></li>
                    <li><a href="#" data-icon="search">Usługi</a></li>
                    <li><a href="#" data-icon="search">Rozrywka</a></li>
                </ul>
            </div>
        </div>
            <div data-role="content" id="map">
            </div>
            <div data-role="footer" data-position="fixed" data-fullscreen="true">
                Sprawdzanie bieżącej lokalizacji ...
            </div>
        </div>
    </body>
    <!--<script type="text/javascript">
        StopGap();
    </script>-->
</html>
